<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Shared Integration Test</title>
    <style>
        body { font-family: Arial, sans-serif; margin: 20px; }
        .test-section { margin: 20px 0; padding: 15px; border: 1px solid #ccc; border-radius: 5px; }
        .result { margin: 10px 0; padding: 10px; background: #f0f0f0; border-radius: 3px; }
        .success { background: #d4edda; color: #155724; border: 1px solid #c3e6cb; }
        .error { background: #f8d7da; color: #721c24; border: 1px solid #f5c6cb; }
        .info { background: #d1ecf1; color: #0c5460; border: 1px solid #bee5eb; }
        .loading { background: #fff3cd; color: #856404; border: 1px solid #ffeaa7; }
        .color-preview { width: 100px; height: 30px; border: 1px solid #000; margin: 5px 0; display: inline-block; }
        .file-list { max-height: 200px; overflow-y: auto; background: #f8f9fa; padding: 10px; border-radius: 3px; }
        .console-output { max-height: 150px; overflow-y: auto; background: #2d3748; color: #e2e8f0; padding: 10px; border-radius: 3px; font-family: monospace; font-size: 12px; }
    </style>
</head>
<body>
    <h1>ğŸ§ª Shared System Integration Test</h1>
    <p>æ–°ã—ã„shared/æ§‹é€ ã§ã®çµ±åˆãƒ†ã‚¹ãƒˆ</p>
    
    <div class="test-section">
        <h2>1. ãƒ•ã‚¡ã‚¤ãƒ«èª­ã¿è¾¼ã¿ç¢ºèª</h2>
        <div id="file-loading-result" class="result loading">ãƒ†ã‚¹ãƒˆä¸­...</div>
        <div id="file-list" class="file-list"></div>
    </div>
    
    <div class="test-section">
        <h2>2. æ„ŸæŸ“ç—‡ã‚·ã‚¹ãƒ†ãƒ çµ±åˆ</h2>
        <div id="disease-system-result" class="result loading">ãƒ†ã‚¹ãƒˆä¸­...</div>
    </div>
    
    <div class="test-section">
        <h2>3. ConfigLoaderçµ±åˆ</h2>
        <div id="config-loader-result" class="result loading">ãƒ†ã‚¹ãƒˆä¸­...</div>
    </div>
    
    <div class="test-section">
        <h2>4. ãƒ‡ãƒ¼ã‚¿èª­ã¿è¾¼ã¿ç¢ºèª</h2>
        <div id="data-loading-result" class="result loading">ãƒ†ã‚¹ãƒˆä¸­...</div>
    </div>
    
    <div class="test-section">
        <h2>5. CSSå¤‰æ•°ãƒ»ãƒ†ãƒ¼ãƒé©ç”¨</h2>
        <div id="css-theme-result" class="result loading">ãƒ†ã‚¹ãƒˆä¸­...</div>
        <div>
            ãƒ—ãƒ©ã‚¤ãƒãƒª: <div class="color-preview" id="primary-preview"></div>
            ã‚»ã‚«ãƒ³ãƒ€ãƒª: <div class="color-preview" id="secondary-preview"></div>
            ã‚¢ã‚¯ã‚»ãƒ³ãƒˆ: <div class="color-preview" id="accent-preview"></div>
        </div>
    </div>
    
    <div class="test-section">
        <h2>6. Manager Classeså‹•ä½œç¢ºèª</h2>
        <div id="managers-result" class="result loading">ãƒ†ã‚¹ãƒˆä¸­...</div>
    </div>
    
    <div class="test-section">
        <h2>7. ã‚³ãƒ³ã‚½ãƒ¼ãƒ«ãƒ­ã‚°</h2>
        <div id="console-output" class="console-output"></div>
    </div>

    <!-- æ„ŸæŸ“ç—‡è¨­å®š -->
    <script>
        window.DISEASE_TYPE = 'aids';
        
        // ã‚³ãƒ³ã‚½ãƒ¼ãƒ«ãƒ­ã‚°ã‚­ãƒ£ãƒ—ãƒãƒ£
        const originalConsole = {
            log: console.log,
            warn: console.warn,
            error: console.error
        };
        
        const consoleOutput = [];
        ['log', 'warn', 'error'].forEach(method => {
            console[method] = function(...args) {
                consoleOutput.push(`[${method.toUpperCase()}] ${args.join(' ')}`);
                originalConsole[method].apply(console, args);
                updateConsoleDisplay();
            };
        });
        
        function updateConsoleDisplay() {
            const output = document.getElementById('console-output');
            output.innerHTML = consoleOutput.slice(-20).join('\n');
            output.scrollTop = output.scrollHeight;
        }
    </script>
    
    <!-- Shared System -->
    <script src="../shared/assets/js/config/disease-config.js"></script>
    <script src="../shared/assets/js/utils/config-loader.js"></script>
    <script src="../shared/assets/js/config/defaults.js"></script>
    
    <!-- Core Utilities -->
    <script src="../shared/assets/js/utils/app-constants.js"></script>
    <script src="../shared/assets/js/utils/base-manager.js"></script>
    <script src="../shared/assets/js/utils/error-handler.js"></script>
    <script src="../shared/assets/js/pubsub.js"></script>
    
    <!-- Test Manager -->
    <script src="../shared/assets/js/chart-manager.js"></script>
    
    <script>
        async function runIntegrationTests() {
            let allTestsPassed = true;
            
            // 1. ãƒ•ã‚¡ã‚¤ãƒ«èª­ã¿è¾¼ã¿ç¢ºèª (ä¿®æ­£ç‰ˆ)
            try {
                const allScripts = Array.from(document.scripts);
                const sharedScripts = allScripts.filter(s => s.src && s.src.includes('../shared/'));
                
                // ã‚ˆã‚Šè©³ç´°ãªã‚¹ã‚¯ãƒªãƒ—ãƒˆæƒ…å ±
                const scriptDetails = allScripts.map(s => ({
                    src: s.src || '(inline)',
                    isShared: s.src && s.src.includes('../shared/'),
                    fileName: s.src ? s.src.split('/').pop() : '(inline)'
                }));
                
                // æœŸå¾…ã•ã‚Œã‚‹sharedãƒ•ã‚¡ã‚¤ãƒ«
                const expectedSharedFiles = [
                    'disease-config.js',
                    'config-loader.js', 
                    'defaults.js',
                    'app-constants.js',
                    'base-manager.js',
                    'error-handler.js',
                    'pubsub.js',
                    'chart-manager.js'
                ];
                
                // ã‚°ãƒ­ãƒ¼ãƒãƒ«ã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆå­˜åœ¨ç¢ºèª
                const globalObjects = {
                    'DISEASE_TYPE': window.DISEASE_TYPE,
                    'DiseaseDetector': !!window.DiseaseDetector,
                    'DISEASE_CONFIG': !!window.DISEASE_CONFIG,
                    'ConfigLoader': !!window.ConfigLoader,
                    'PubSub': !!window.pubsub,
                    'BaseManager': !!window.BaseManager,
                    'ChartManager': !!window.ChartManager
                };
                
                const loadedGlobals = Object.values(globalObjects).filter(Boolean).length;
                
                // ãƒ‡ãƒãƒƒã‚°æƒ…å ±
                console.log('ğŸ” Enhanced Script Debug:');
                console.log('Total scripts:', allScripts.length);
                console.log('Shared scripts detected:', sharedScripts.length);
                console.log('Global objects loaded:', loadedGlobals);
                console.log('Script details:', scriptDetails);
                
                // è©³ç´°è¡¨ç¤º
                const fileListHtml = `
                    <strong>ã‚¹ã‚¯ãƒªãƒ—ãƒˆè©³ç´° (${allScripts.length}å€‹):</strong><br>
                    ${scriptDetails.map(s => `${s.isShared ? 'âœ…' : 'ğŸ“„'} ${s.fileName} - ${s.src}`).join('<br>')}<br><br>
                    <strong>æœŸå¾…ãƒ•ã‚¡ã‚¤ãƒ«:</strong><br>
                    ${expectedSharedFiles.join(', ')}<br><br>
                    <strong>ã‚°ãƒ­ãƒ¼ãƒãƒ«ã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆ (${loadedGlobals}/7):</strong><br>
                    ${Object.entries(globalObjects).map(([key, value]) => `${value ? 'âœ…' : 'âŒ'} ${key}`).join('<br>')}
                `;
                document.getElementById('file-list').innerHTML = fileListHtml;
                
                // æˆåŠŸåˆ¤å®š: ã‚¹ã‚¯ãƒªãƒ—ãƒˆæ•°ã¾ãŸã¯ã‚°ãƒ­ãƒ¼ãƒãƒ«ã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆæ•°ã§åˆ¤å®š
                if (sharedScripts.length >= 4 || loadedGlobals >= 6) {
                    document.getElementById('file-loading-result').innerHTML = 
                        `âœ… æˆåŠŸ: ãƒ•ã‚¡ã‚¤ãƒ«èª­ã¿è¾¼ã¿ç¢ºèª<br>
                        æ¤œå‡ºæ–¹æ³•: Shared scripts = ${sharedScripts.length}, Globals = ${loadedGlobals}<br>
                        åˆ¤å®š: ${sharedScripts.length >= 4 ? 'ã‚¹ã‚¯ãƒªãƒ—ãƒˆæ•°' : 'ã‚°ãƒ­ãƒ¼ãƒãƒ«æ•°'}ã«ã‚ˆã‚ŠæˆåŠŸ`;
                    document.getElementById('file-loading-result').className = 'result success';
                } else {
                    throw new Error(`ä¸¡æ–¹ã¨ã‚‚ä¸è¶³ - Scripts: ${sharedScripts.length}/4, Globals: ${loadedGlobals}/6`);
                }
            } catch (error) {
                document.getElementById('file-loading-result').innerHTML = 
                    `âŒ å¤±æ•—: ${error.message}`;
                document.getElementById('file-loading-result').className = 'result error';
                allTestsPassed = false;
            }
            
            // 2. æ„ŸæŸ“ç—‡ã‚·ã‚¹ãƒ†ãƒ çµ±åˆ
            try {
                if (window.DiseaseDetector && window.DISEASE_CONFIG) {
                    const diseaseType = window.DiseaseDetector.getDiseaseType();
                    const diseaseConfig = window.DiseaseDetector.getDiseaseConfig();
                    
                    document.getElementById('disease-system-result').innerHTML = 
                        `âœ… æˆåŠŸ: æ„ŸæŸ“ç—‡ã‚·ã‚¹ãƒ†ãƒ çµ±åˆå®Œäº†<br>
                        ã‚¿ã‚¤ãƒ—: ${diseaseType}<br>
                        åå‰: ${diseaseConfig.name}<br>
                        ã‚«ãƒ©ãƒ¼: ${diseaseConfig.color.primary}`;
                    document.getElementById('disease-system-result').className = 'result success';
                } else {
                    throw new Error('DiseaseDetector ã¾ãŸã¯ DISEASE_CONFIG ãŒåˆ©ç”¨ã§ãã¾ã›ã‚“');
                }
            } catch (error) {
                document.getElementById('disease-system-result').innerHTML = 
                    `âŒ å¤±æ•—: ${error.message}`;
                document.getElementById('disease-system-result').className = 'result error';
                allTestsPassed = false;
            }
            
            // 3. ConfigLoaderçµ±åˆ
            try {
                await window.ConfigLoader.loadAll();
                const legacyConfig = window.ConfigLoader.getLegacyCompatibleConfig();
                const diseaseConfig = window.ConfigLoader.getDiseaseConfig();
                
                document.getElementById('config-loader-result').innerHTML = 
                    `âœ… æˆåŠŸ: ConfigLoaderçµ±åˆå®Œäº†<br>
                    Steps: ${legacyConfig.steps?.length || 0}å€‹<br>
                    æ„ŸæŸ“ç—‡çµ±åˆ: ${diseaseConfig ? 'âœ…' : 'âŒ'}`;
                document.getElementById('config-loader-result').className = 'result success';
            } catch (error) {
                document.getElementById('config-loader-result').innerHTML = 
                    `âŒ å¤±æ•—: ${error.message}`;
                document.getElementById('config-loader-result').className = 'result error';
                allTestsPassed = false;
            }
            
            // 4. ãƒ‡ãƒ¼ã‚¿èª­ã¿è¾¼ã¿ç¢ºèª
            try {
                const testDataPath = window.ConfigLoader.resolveDataPath('cities-timeline.json');
                const response = await fetch(testDataPath);
                
                if (response.ok) {
                    const data = await response.json();
                    document.getElementById('data-loading-result').innerHTML = 
                        `âœ… æˆåŠŸ: ãƒ‡ãƒ¼ã‚¿èª­ã¿è¾¼ã¿ç¢ºèª<br>
                        ãƒ‘ã‚¹: ${testDataPath}<br>
                        éƒ½å¸‚æ•°: ${data.cities?.length || 0}å€‹`;
                    document.getElementById('data-loading-result').className = 'result success';
                } else {
                    throw new Error(`HTTP ${response.status}: ${testDataPath}`);
                }
            } catch (error) {
                document.getElementById('data-loading-result').innerHTML = 
                    `âŒ å¤±æ•—: ${error.message}`;
                document.getElementById('data-loading-result').className = 'result error';
                allTestsPassed = false;
            }
            
            // 5. CSSå¤‰æ•°ãƒ»ãƒ†ãƒ¼ãƒé©ç”¨
            try {
                const root = getComputedStyle(document.documentElement);
                const primaryColor = root.getPropertyValue('--disease-color-primary').trim();
                const secondaryColor = root.getPropertyValue('--disease-color-secondary').trim();
                const accentColor = root.getPropertyValue('--disease-color-accent').trim();
                
                document.getElementById('primary-preview').style.backgroundColor = primaryColor;
                document.getElementById('secondary-preview').style.backgroundColor = secondaryColor;
                document.getElementById('accent-preview').style.backgroundColor = accentColor;
                
                if (primaryColor && secondaryColor && accentColor) {
                    document.getElementById('css-theme-result').innerHTML = 
                        `âœ… æˆåŠŸ: CSSå¤‰æ•°é©ç”¨å®Œäº†<br>
                        Primary: ${primaryColor}<br>
                        Secondary: ${secondaryColor}<br>
                        Accent: ${accentColor}`;
                    document.getElementById('css-theme-result').className = 'result success';
                } else {
                    throw new Error('CSSå¤‰æ•°ãŒæ­£ã—ãè¨­å®šã•ã‚Œã¦ã„ã¾ã›ã‚“');
                }
            } catch (error) {
                document.getElementById('css-theme-result').innerHTML = 
                    `âŒ å¤±æ•—: ${error.message}`;
                document.getElementById('css-theme-result').className = 'result error';
                allTestsPassed = false;
            }
            
            // 6. Manager Classeså‹•ä½œç¢ºèª
            try {
                const managersAvailable = {
                    ChartManager: !!window.ChartManager,
                    BaseManager: !!window.BaseManager,
                    PubSub: !!window.pubsub,
                    ErrorHandler: !!window.ErrorHandler
                };
                
                const availableCount = Object.values(managersAvailable).filter(Boolean).length;
                
                if (availableCount >= 3) {
                    document.getElementById('managers-result').innerHTML = 
                        `âœ… æˆåŠŸ: Manager Classesåˆ©ç”¨å¯èƒ½<br>
                        ${Object.entries(managersAvailable)
                            .map(([name, available]) => `${name}: ${available ? 'âœ…' : 'âŒ'}`)
                            .join('<br>')}`;
                    document.getElementById('managers-result').className = 'result success';
                } else {
                    throw new Error(`åˆ©ç”¨å¯èƒ½Manager: ${availableCount}/4`);
                }
            } catch (error) {
                document.getElementById('managers-result').innerHTML = 
                    `âŒ å¤±æ•—: ${error.message}`;
                document.getElementById('managers-result').className = 'result error';
                allTestsPassed = false;
            }
            
            // ç·åˆçµæœ
            if (allTestsPassed) {
                document.title = 'âœ… All Tests Passed - Shared Integration Test';
                console.log('ğŸ‰ å…¨çµ±åˆãƒ†ã‚¹ãƒˆæˆåŠŸï¼ãƒ•ã‚§ãƒ¼ã‚º2å®Œäº†ï¼');
            } else {
                document.title = 'âŒ Some Tests Failed - Shared Integration Test';
                console.log('âš ï¸ ä¸€éƒ¨çµ±åˆãƒ†ã‚¹ãƒˆå¤±æ•—ã€‚è¦ä¿®æ­£ã€‚');
            }
        }
        
        // ãƒ†ã‚¹ãƒˆå®Ÿè¡Œ
        window.addEventListener('load', () => {
            setTimeout(runIntegrationTests, 1000);
        });
    </script>
</body>
</html>